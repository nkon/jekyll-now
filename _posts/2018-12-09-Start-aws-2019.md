---
layout: post
title: Amazon Web Service の始め方(2019年版)
category: blog
tags: aws
---

仕事で、実験用に外へつながったサーバが必要になった。
しかし、いろいろ手続きが大変なので、とりあえず自分のアカウントで作業することにした。
ウェブを探しても、この進歩が早い世の中で、古い記事が混じっていたりする。
自分の作業メモを兼ねて、現時点でのはじめ方をまとめておこう。

## 概要

1. VCP構築
2. EC2構築

## VCP構築

当面の目的はEC2サーバに自前のサーバを立ち上げて、ノードからのデータを受信すること。

しかし、サーバをそのままインターネットに露出するわけにもいかず、まずはVCPを構築する。

VCPとは [Virtual Private Cloud](https://aws.amazon.com/jp/vpc/) の略で、AWSクラウドの中に論理的に区画を区切ってプライベートクラウドを作る事。VPCを構築することで、サブネットへの分割、プライベートサブネット、ホストアクセス制御などが可能になる。

デフォルトの状態で、VPC 1個、サブネット3個、ルートテーブル1個、インターネットゲートウェイ1個…がセットされている。基本的にデフォルトで問題ないが、重要なところは名付けがてら確認しておこう。

<div align="center"><img src="/images/aws-vpc-1.png" alt="aws-vpc-1"></div>

### VPC作成

1. AWSマネジメントコンソール→サービス から[VPC]を選択。
2. すでにデフォルトVPCが1台居るので、Name の鉛筆アイコンを押して名前を付ける。

### インターネットゲートウェイの設定

VPCをインターネットに接続して、外からアクセスできるようにする。

1. VPCダッシュボードから インターネットゲートウェイ を選択。
2. すでにデフォルトのインターネットゲートウェイが居るので、Name の鉛筆アイコンを押して名前を付ける。VPCの列に、先ほどのVPCがつながっていること、状態が attached になっていることを確認する。

### ルートテーブルの設定

ゲートウェイに対してルートを設定して、トラフィックを導く。

1. VPCダッシュボードから[ルートテーブル]を選択。
2. すでにデフォルトのルートテーブルがあるので、Name の鉛筆アイコンを押して名前を付ける。下の方の設定タブの Routes で Destination 0.0.0.0/0(インターネット)が先ほど設定したゲートウェイのターゲットに向かっていることを確認する。

## EC2構築

上で構築したVCP内にELBとEC2を配置する。ELBは[Elastic Load Balancing](https://aws.amazon.com/jp/elasticloadbalancing/)の略でサーバへの負荷を調整する。EC2が実際のサーバとなる。

### EC2作成

[AWSマネジメントコンソール]→[サービス]から EC2 を選択。インスタンスの作成ボタンを押す。ステップごとに設定をしていく。

1. まずはOSの選択。Amazon Linux か Ubunt Server の選択になるだろう。ここでは使い慣れた Ubuntu Server x86_64 を選択。
2. インスタンスタイプの選択。無料枠の場合は t2.micro, 1vCPU, 1GiBメモリの一択。この時点で[確認と作成]ボタンを押してもいいが、インスタンス詳細も設定してしまう。
3. インスタンス詳細の設定。デフォルトでいい感じになっていると思うが、ネットワーク設定などを確認しておく。
4. ストレージの追加。デフォルトで 8BGの汎用SSDが割り当たっている。これで十分だと思うが30GBまでの汎用SSDが無料枠で使えるので増やしたければ増やす。
5. タグの追加。タグは Name と Value の両方を自由にセットできる。わかりやすい名前を付けておこう。
6. セキュリティグループ。アクセスポリシーのようなもの。デフォルトでは 0.0.0.0/0 つまりインターネット全体からアクセス可能なようになっている。動作確認では、[マイIP]を指定すれば、今アクセスしているアドレスからのみアクセスできる(便利)。実運用ではEC2へのアクセスはELB経由となる。つまりローカルネットからのみアクセスできるように設定することになる。とりあえず SSH, HTTP, HTTPSぐらいを[マイIP]に設定しておけばいいだろう。
7. これで[確認と作成]ボタンを押せば、確認画面が出てくる。
8. 作成ボタンを押せば、初回であれば、キーペアのダイアログボックスが出てくる。新しいキーペアを作成する。~/.ssh/ に保存しておく。パーミッションは 0600 だ。バックアップも忘れずに。この鍵が無ければアクセスできない。
9. 作成ボタンを押せば、すこし時間がかかるが作成される。作成ログを見て作成が完了していれば、すでに実行されている。
10. 念の為、請求アラートをONにしておこう。

### EC2アクセス(SSH)

EC2ダッシュボードから起動を確認できる。

* パブリックDNSが設定されているので、クリップボードにコピーする。
* コマンドラインから `ssh ubuntu@<パブリックDNSの値> -i <キーのパス>`で接続できる。
* ダッシュボードの上の[接続]ボタンを押せば、接続方法を、自分の設定に合わせて(キーファイル名やDNSを埋め込んで)表示してくれるのでコピペでOK。

### Nginxのインストール

* `apt-get install nginx`でインストールされる。
* ウェブブラウザから、上記のパブリックDNSにアクセスして「ようこそ！」画面が見えればOK。

使い終わったら、ダッシュボードから[アクション]→[インスタンスの状態]→[停止]しておこう。
